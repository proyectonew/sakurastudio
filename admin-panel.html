<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Panel Administrativo â€“ Sakura Studio</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      background-image: url('fondo-sakura.jpg');
      background-size: cover;
      background-position: center;
      color: #333;
      display: flex;
      height: 100vh;
    }
    aside {
      width: 250px;
      background: rgba(255, 255, 255, 0.95);
      padding: 20px;
      box-shadow: 2px 0 5px rgba(0,0,0,0.1);
    }
    aside img {
      width: 100%;
      max-width: 180px;
      margin-bottom: 20px;
    }
    aside button {
      display: block;
      width: 100%;
      margin: 10px 0;
      padding: 10px;
      font-weight: bold;
      background-color: #e91e63;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    main {
      flex: 1;
      padding: 30px;
      overflow-y: auto;
      background: rgba(255, 255, 255, 0.9);
    }
    .section {
      margin-bottom: 40px;
    }
    h2 {
      color: #e91e63;
      margin-bottom: 10px;
    }
    input, select, textarea {
      width: 100%;
      padding: 10px;
      margin: 8px 0;
      border-radius: 5px;
      border: 1px solid #ccc;
      font-size: 16px;
    }
    button.action {
      background-color: #e91e63;
      color: white;
      border: none;
      font-weight: bold;
      padding: 10px;
      margin-top: 10px;
      border-radius: 5px;
      cursor: pointer;
    }
    .result {
      font-weight: bold;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <aside>
    <img src="logo-sakura.png" alt="Logo Sakura" />
    <button onclick="mostrarSeccion('tasa')">ğŸ“Š Tasa Oficial</button>
    <button onclick="mostrarSeccion('servicios')">ğŸ›ï¸ Servicios</button>
    <button onclick="mostrarSeccion('trabajadoras')">ğŸ‘©â€ğŸ’¼ Trabajadoras</button>
    <button onclick="mostrarSeccion('gastos')">ğŸ’¸ Gastos</button>
    <button onclick="mostrarSeccion('liquidez')">ğŸ’° Liquidez</button>
    <button onclick="mostrarSeccion('pagos')">ğŸ“‹ Pagos</button>
    <button onclick="mostrarSeccion('cierre')">ğŸ“† Cierre Semanal</button>
    <button onclick="mostrarSeccion('resumen')">ğŸ“ˆ Resumen Diario</button>
  </aside>

  <main id="panel">
    <!-- AquÃ­ se cargan dinÃ¡micamente las secciones -->
  </main>

  <!-- Secciones modulares -->
  <template id="tasa">
    <div class="section">
      <h2>ğŸ“Š Tasa Oficial</h2>
      <div id="tasaActual">Cargando tasa...</div>
      <label>Registrar tasa manual (solo contingencia)</label>
      <input type="number" id="tasaManual" placeholder="Ej: 150.00" />
      <button class="action" onclick="registrarTasaManual()">Registrar tasa manual</button>
      <div id="tasaFeedback"></div>
    </div>
  </template>

  <template id="servicios">
    <div class="section">
      <h2>ğŸ›ï¸ Servicios</h2>
      <label>Nombre del servicio</label>
      <input type="text" id="nombreServicio" />
      <label>Precio en USD</label>
      <input type="number" id="precioServicio" />
      <button class="action" onclick="registrarServicio()">Registrar servicio</button>
      <div id="servicioFeedback"></div>
    </div>
  </template>

  <template id="trabajadoras">
    <div class="section">
      <h2>ğŸ‘©â€ğŸ’¼ Trabajadoras</h2>
      <label>Nombre</label>
      <input type="text" id="nombreTrabajadora" />
      <label>Porcentaje de ganancia</label>
      <input type="number" id="porcentajeTrabajadora" placeholder="Ej: 50" />
      <button class="action" onclick="registrarTrabajadora()">Registrar trabajadora</button>
      <div id="trabajadoraFeedback"></div>
    </div>
  </template>

  <template id="gastos">
    <div class="section">
      <h2>ğŸ’¸ Registro de Gastos</h2>
      <label>Concepto del gasto</label>
      <input type="text" id="conceptoGasto" />
      <label>Monto</label>
      <input type="number" id="montoGasto" />
      <label>Moneda</label>
      <select id="monedaGasto">
        <option value="usd">USD</option>
        <option value="bs">Bs</option>
      </select>
      <label>Tipo de gasto</label>
      <select id="tipoGasto">
        <option value="fijo">Fijo</option>
        <option value="variable">Variable</option>
      </select>
      <label>NÃºmero de factura</label>
      <input type="text" id="facturaGasto" />
      <label>Referencia bancaria (Ãºltimos 4 dÃ­gitos)</label>
      <input type="text" id="referenciaGasto" />
      <label>Responsable</label>
      <input type="text" id="responsableGasto" />
      <button class="action" onclick="registrarGasto()">Registrar gasto</button>
      <div id="gastoFeedback"></div>
    </div>
  </template>

  <template id="liquidez">
    <div class="section">
      <h2>ğŸ’° Liquidez Actual</h2>
      <button class="action" onclick="verLiquidez()">Actualizar liquidez</button>
      <div id="liquidezVisual">â€”</div>
    </div>
  </template>

  <template id="pagos">
    <div class="section">
      <h2>ğŸ“‹ AuditorÃ­a de Pagos</h2>
      <button class="action" onclick="verPagos()">Ver pagos recientes</button>
      <div id="pagosVisual">â€”</div>
    </div>
  </template>

  <template id="cierre">
    <div class="section">
      <h2>ğŸ“† Cierre Semanal</h2>
      <label>Seleccionar trabajadora</label>
      <select id="trabajadoraCierre"></select>
      <label>Fecha de cierre</label>
      <input type="date" id="fechaCierre" />
      <button class="action" onclick="calcularCierre()">Calcular cierre</button>
      <div id="resultadoCierre">â€”</div>
      <label>Monto a entregar en USD</label>
      <input type="number" id="usdEntregadoCierre" placeholder="Ej: 80.00" />
      <button class="action" onclick="registrarCierre()">Registrar cierre y egresos</button>
      <div id="feedbackCierre"></div>
    </div>
  </template>

  <template id="resumen">
    <div class="section">
      <h2>ğŸ“ˆ Ingresos por Moneda</h2>
      <button class="action" onclick="verResumenDiario()">Ver resumen diario</button>
      <div id="resumenDiarioVisual">â€”</div>
    </div>
  </template>

  <script type="module">
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

  const supabase = createClient(
    "https://whsyicvodgtmhsoynyrc.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indoc3lpY3ZvZGd0bWhzb3lueXJjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY5NTI5MDcsImV4cCI6MjA3MjUyODkwN30.8NdIOa08ntLFriC4wOWhyMcOmF4Q3fLcG1rwcnZffOE"
  );

  function mostrarSeccion(id) {
    const panel = document.getElementById('panel');
    const template = document.getElementById(id);
    panel.innerHTML = '';
    panel.appendChild(template.content.cloneNode(true));

    switch (id) {
      case 'tasa':
        verTasa();
        break;
      case 'trabajadoras':
        cargarTrabajadorasCierre();
        break;
      case 'resumen':
        verResumenDiario();
        break;
      case 'liquidez':
        verLiquidez();
        break;
      case 'pagos':
        verPagos();
        break;
    }
  }

  async function verTasa() {
    const { data, error } = await supabase
      .from('tasa_dia')
      .select('tasa_bs_por_usd, fecha')
      .eq('tipo_uso', 'operativo')
      .order('fecha', { ascending: false })
      .limit(1)
      .single();
    document.getElementById('tasaActual').textContent = error
      ? 'Error al cargar tasa'
      : `Tasa vigente: ${data.tasa_bs_por_usd} Bs/USD (fecha: ${data.fecha})`;
  }

  async function registrarTasaManual() {
    const tasaManual = parseFloat(document.getElementById('tasaManual').value);
    if (!tasaManual) return;
    const { error } = await supabase.rpc('registrar_tasa_manual', {
      fuente: 'manual',
      tasa_bs_por_usd: tasaManual
    });
    document.getElementById('tasaFeedback').textContent = error
      ? 'âŒ Error al registrar tasa'
      : 'âœ… Tasa registrada correctamente';
    verTasa();
  }

  async function registrarServicio() {
    const nombre = document.getElementById('nombreServicio').value;
    const precio = parseFloat(document.getElementById('precioServicio').value);
    if (!nombre || !precio) return;
    const { error } = await supabase.from('servicios').insert([{ nombre, precio_usd: precio }]);
    document.getElementById('servicioFeedback').textContent = error
      ? 'âŒ Error al registrar servicio'
      : 'âœ… Servicio registrado correctamente';
  }

  async function registrarTrabajadora() {
    const nombre = document.getElementById('nombreTrabajadora').value;
    const porcentaje = parseFloat(document.getElementById('porcentajeTrabajadora').value);
    if (!nombre || !porcentaje) return;
    const { error } = await supabase.from('trabajadoras').insert([{ nombre, porcentaje_ganancia: porcentaje }]);
    document.getElementById('trabajadoraFeedback').textContent = error
      ? 'âŒ Error al registrar trabajadora'
      : 'âœ… Trabajadora registrada correctamente';
  }

  async function registrarGasto() {
    const concepto = document.getElementById('conceptoGasto').value;
    const monto = parseFloat(document.getElementById('montoGasto').value);
    const moneda = document.getElementById('monedaGasto').value;
    const tipo = document.getElementById('tipoGasto').value;
    const factura = document.getElementById('facturaGasto').value;
    const referencia_bancaria = document.getElementById('referenciaGasto').value;
    const responsable = document.getElementById('responsableGasto').value;
    if (!concepto || !monto || !moneda || !tipo || !responsable) return;
    const { error } = await supabase.from('egresos').insert([{
      concepto,
      monto,
      moneda,
      tipo,
      factura,
      referencia_bancaria,
      responsable
    }]);
    document.getElementById('gastoFeedback').textContent = error
      ? 'âŒ Error al registrar gasto'
      : 'âœ… Gasto registrado correctamente';
  }

  async function verLiquidez() {
    const { data, error } = await supabase.from('liquidez_actual').select('*').single();
    document.getElementById('liquidezVisual').textContent = error
      ? 'âŒ Error al cargar liquidez'
      : `USD: $${data.efectivo_usd.toFixed(2)} | Bs: Bs ${data.efectivo_bs.toFixed(2)} | Banco Bs: Bs ${data.banco_bs.toFixed(2)}`;
  }

  async function verPagos() {
    const { data, error } = await supabase
      .from('pagos')
      .select('created_at, servicio, monto_usd, moneda, metodo_pago, trabajadora, monto_entregado_usd, monto_entregado_bs, vuelto_bs')
      .order('created_at', { ascending: false })
      .limit(10);
    if (error || !data) {
      document.getElementById('pagosVisual').textContent = 'âŒ Error al cargar pagos';
      return;
    }
    document.getElementById('pagosVisual').innerHTML = data.map(p =>
      `<div>ğŸ§¾ ${p.created_at.split('T')[0]} â€“ ${p.servicio} â€“ $${p.monto_usd} â€“ ${p.moneda} â€“ ${p.metodo_pago} â€“ Vuelto Bs: ${p.vuelto_bs || 0}</div>`
    ).join('');
  }

  async function cargarTrabajadorasCierre() {
    const { data, error } = await supabase.from('trabajadoras').select('id, nombre').eq('activo', true);
    const selector = document.getElementById('trabajadoraCierre');
    if (error || !data) {
      selector.innerHTML = '<option>Error al cargar</option>';
      return;
    }
    selector.innerHTML = '';
    data.forEach(t => {
      const opt = document.createElement('option');
      opt.value = t.id;
      opt.textContent = t.nombre;
      selector.appendChild(opt);
    });
  }

  let cierreCalculado = null;

  async function calcularCierre() {
    const trabajadora = document.getElementById('trabajadoraCierre').value;
    const fecha = document.getElementById('fechaCierre').value;
    if (!trabajadora || !fecha) return;

    const { data, error } = await supabase.rpc('calcular_cierre_trabajadora', {
      trabajadora_id: trabajadora,
      fecha_corte: fecha
    });

    if (error || !data) {
      document.getElementById('resultadoCierre').textContent = 'âŒ Error al calcular cierre';
      cierreCalculado = null;
      return;
    }

    cierreCalculado = data;
    const totalUSD = data.comision_usd + data.propina_usd;
    const totalBs = data.propina_bs;
    document.getElementById('resultadoCierre').innerHTML = `
      ComisiÃ³n USD: $${data.comision_usd.toFixed(2)}<br>
      Propina USD: $${data.propina_usd.toFixed(2)}<br>
      Propina Bs: Bs ${data.propina_bs.toFixed(2)}<br>
      Total a pagar: $${totalUSD.toFixed(2)} + Bs ${totalBs.toFixed(2)}
    `;
  }

  async function registrarCierre() {
    if (!cierreCalculado) return;
    const trabajadora = document.getElementById('trabajadoraCierre').value;
    const fecha = document.getElementById('fechaCierre').value;
    const usdEntregado = parseFloat(document.getElementById('usdEntregadoCierre').value) || 0;
    const totalUSD = cierreCalculado.comision_usd + cierreCalculado.propina_usd;
    const restanteUSD = totalUSD - usdEntregado;
    const compensadoBs = restanteUSD > 0 ? restanteUSD * cierreCalculado.tasa : 0;

    if (usdEntregado > 0) {
      await supabase.from('movimientos_caja').insert([{
        tipo: 'egreso',
        canal: 'efectivo_usd',
        monto: usdEntregado,
        concepto: `Pago cierre semanal a trabajadora`,
        responsable: 'admin'
      }]);
    }

    if (compensadoBs > 0) {
      await supabase.from('movimientos_caja').insert([{
        tipo: 'egreso',
        canal: 'efectivo_bs',
        monto: compensadoBs,
        concepto: `CompensaciÃ³n cierre semanal en Bs`,
        responsable: 'admin'
      }]);
    }

    await supabase.from('cierres').insert([{
      trabajadora_id: trabajadora,
      fecha_corte: fecha,
      comision_usd: cierreCalculado.comision_usd,
      propina_usd: cierreCalculado.propina_usd,
      propina_bs: cierreCalculado.propina_bs,
      usd_entregado: usdEntregado,
      bs_compensado: compensadoBs,
      tasa: cierreCalculado.tasa,
      responsable: 'admin'
    }]);

    document.getElementById('feedbackCierre').textContent = 'âœ… Cierre registrado correctamente';
    cierreCalculado = null;
  }

  async function verResumenDiario() {
    const { data, error } = await supabase.from('ingresos_por_moneda').select('*');
    if (error || !data) {
      document.getElementById('resumenDiarioVisual').textContent = 'âŒ Error al cargar resumen';
      return;
    }
    document.getElementById('resumenDiarioVisual').innerHTML = data.map(r =>
      `<div>ğŸ“… ${r.fecha} â€“ USD: $${r.total_usd.toFixed(2)} â€“ Bs: Bs ${r.total_bs.toFixed(2)}</div>`
    ).join('');
  }

  window.addEventListener('DOMContentLoaded', () => {
    mostrarSeccion('resumen');
  });
</script>
      
</body>
</html>
